require 'gepub'
require 'optparse'

def usage
  STDERR.print "gepuber [-d destination ] [-c configfilename] <source-directory>\r\n"
  exit 1
end

def srccheck(srcdir, configfilename)
  if !File.exist?(srcdir) || !File.directory?(srcdir) 
    STDERR.print "#{srcdir} is not a directory"
    exit 1
  end
  if !File.exist?(File.join(srcdir, configfilename))
    STDERR.print "#{configfilename} does not exists in#{srcdir}."
    exit 1
  end
end

def destcheck(destdir)
  if (File.exist?(destdir) && !File.directory?(destdir))
    STDERR.print "#{destdir} is not a directory\n"
    exit 1
  end
end

destbasedir = "."
configfilename = 'gepuber.conf'

opt = OptionParser.new

usage if ARGV.length < 1

opt.on('-d [directory]') { |dir|
  destbasedir = dir
}

opt.on('-c [configfilename]') { |name|
  configfilename = name
}

destbasedir = File.expand_path(destbasedir)

srcdir = opt.parse(ARGV)[0]
srccheck(srcdir, configfilename)

Dir.chdir(srcdir)
begin
  File.open(configfilename, 'rb') {
    |io|
    gepuber = GEPUB::Gepuber.new(eval("#{io.read}"))
    gepuber.create destbasedir
  }
end

